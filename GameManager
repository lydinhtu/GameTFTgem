extends Node3D

var mau_tuong = preload("res://Tuong_Test.tscn")
var tien_vang = 100
var unit_dang_chon = null 

func _ready():
	var nut_mua = get_node_or_null("UI/NutMuaLinh")
	if nut_mua: nut_mua.pressed.connect(_khi_bam_mua_linh)
	
	await get_tree().create_timer(0.5).timeout
	ket_noi_cac_o()

func ket_noi_cac_o():
	var tat_ca_cac_o = []
	var ban_co = get_node_or_null("BanCo")
	if ban_co: tat_ca_cac_o.append_array(ban_co.get_children())
	var hang_cho = get_node_or_null("HangCho")
	if hang_cho: tat_ca_cac_o.append_array(hang_cho.get_children())
	
	for o in tat_ca_cac_o:
		var body = o.get_node_or_null("StaticBody3D")
		if not body: body = o.get_node_or_null("Slot_1/StaticBody3D")
		
		if body:
			if body.input_event.is_connected(_khi_click_vao_o):
				body.input_event.disconnect(_khi_click_vao_o)
			body.input_event.connect(_khi_click_vao_o.bind(o))
	print("‚úÖ ƒê√£ k·∫øt n·ªëi xong c√°c √¥!")

# --- MUA L√çNH ---
func _khi_bam_mua_linh():
	if tien_vang < 10: return
	var hang_cho = get_node("HangCho")
	var slot_tim_duoc = null
	
	for slot in hang_cho.get_children():
		if "Enemy" in slot.name or not slot.name.begins_with("Slot"): continue
		
		# Ki·ªÉm tra xem c√≥ ai ƒë·ª©ng ch∆∞a (tr·∫£ v·ªÅ null l√† tr·ªëng)
		if tim_tuong_tai_vi_tri(slot.global_position) == null:
			slot_tim_duoc = slot
			break 
	
	if slot_tim_duoc:
		tien_vang -= 10
		sinh_linh(slot_tim_duoc) 
	else:
		print("‚õî H·∫øt ch·ªó r·ªìi!")

func sinh_linh(slot_dich):
	var linh = mau_tuong.instantiate()
	add_child(linh)
	linh.add_to_group("DongMinh")
	
	# C·ªông 1.5m ƒë·ªÉ ƒë·ª©ng h·∫≥n l√™n tr√™n (tr√°nh l√∫n)
	linh.global_position = slot_dich.global_position + Vector3(0, 1.5, 0)
	linh.input_ray_pickable = true

# --- LOGIC CH·ªåN T∆Ø·ªöNG (ƒê√É S·ª¨A: X·ª¨ L√ù ƒê·ªîI CH·ªñ) ---
func chon_tuong(u_moi):
	# TR∆Ø·ªúNG H·ª¢P 1: Ch∆∞a c·∫ßm con n√†o -> Th√¨ ch·ªçn con n√†y
	if unit_dang_chon == null:
		unit_dang_chon = u_moi
		print("üëâ ƒê√£ ch·ªçn: ", u_moi.name)
		return

	# TR∆Ø·ªúNG H·ª¢P 2: Click l·∫°i v√†o ch√≠nh con ƒëang c·∫ßm -> B·ªè ch·ªçn
	if unit_dang_chon == u_moi:
		unit_dang_chon = null
		print("‚èπÔ∏è B·ªè ch·ªçn")
		return

	# TR∆Ø·ªúNG H·ª¢P 3: ƒêang c·∫ßm con A m√† click v√†o con B -> ƒê·ªîI CH·ªñ
	if unit_dang_chon != u_moi:
		print("üîÑ Ph√°t hi·ªán click v√†o ƒë·ªìng ƒë·ªôi -> Ho√°n ƒë·ªïi!")
		
		# G·ªçi h√†m ƒë·ªïi ch·ªó
		thuc_hien_hoan_doi(unit_dang_chon, u_moi)
		
		# ƒê·ªïi xong th√¨ b·ªè ch·ªçn lu√¥n cho r·∫£nh tay
		unit_dang_chon = null

# --- LOGIC CLICK V√ÄO √î ƒê·∫§T ---
func _khi_click_vao_o(cam, ev, pos, nor, idx, o_dat):
	if ev is InputEventMouseButton and ev.button_index == MOUSE_BUTTON_LEFT and ev.pressed:
		
		if unit_dang_chon:
			# 1. Ki·ªÉm tra xem √¥ ƒë√≠ch c√≥ ai ƒë·ª©ng kh√¥ng?
			var tuong_o_dich = tim_tuong_tai_vi_tri(o_dat.global_position, unit_dang_chon)
			
			# === TR∆Ø·ªúNG H·ª¢P A: √î ƒê√çCH C√ì NG∆Ø·ªúI -> HO√ÅN ƒê·ªîI ===
			if tuong_o_dich != null:
				# G·ªçi h√†m d√πng chung (ƒë·ª° ph·∫£i vi·∫øt l·∫°i logic)
				thuc_hien_hoan_doi(unit_dang_chon, tuong_o_dich)
			
			# === TR∆Ø·ªúNG H·ª¢P B: √î ƒê√çCH TR·ªêNG -> ƒêI B√åNH TH∆Ø·ªúNG ===
			else:
				print("üöÄ Di chuy·ªÉn ƒë·∫øn: ", o_dat.name)
				unit_dang_chon.di_chuyen_den(o_dat.global_position)
			
			unit_dang_chon = null # B·ªè ch·ªçn xong

# --- C√ÅC H√ÄM H·ªñ TR·ª¢ ---

# H√†m th·ª±c hi·ªán ƒë·ªïi ch·ªó 2 con t∆∞·ªõng (D√πng chung)
func thuc_hien_hoan_doi(unit_1, unit_2):
	print("‚ôªÔ∏è B·∫Øt ƒë·∫ßu ƒë·ªïi ch·ªó: ", unit_1.name, " <-> ", unit_2.name)
	
	# T√¨m c√°i gh·∫ø (Slot/Tile) d∆∞·ªõi ch√¢n 2 con
	var slot_1 = tim_slot_duoi_chan(unit_1.global_position)
	var slot_2 = tim_slot_duoi_chan(unit_2.global_position)
	
	if slot_1 and slot_2:
		# Con 1 ch·∫°y sang gh·∫ø 2
		unit_1.di_chuyen_den(slot_2.global_position)
		# Con 2 ch·∫°y sang gh·∫ø 1
		unit_2.di_chuyen_den(slot_1.global_position)
	else:
		print("‚ùå L·ªói: M·ªôt trong hai con ƒëang bay l∆° l·ª≠ng, kh√¥ng t√¨m th·∫•y gh·∫ø!")

# H√†m t√¨m xem c√≥ con t∆∞·ªõng n√†o ƒëang ƒë·ª©ng ·ªü v·ªã tr√≠ n√†y kh√¥ng
func tim_tuong_tai_vi_tri(vi_tri_check, tuong_dang_chon_bo_qua = null):
	var ds_tuong = get_tree().get_nodes_in_group("DongMinh")
	for tuong in ds_tuong:
		if tuong == tuong_dang_chon_bo_qua: continue
		
		var p1 = Vector2(tuong.global_position.x, tuong.global_position.z)
		var p2 = Vector2(vi_tri_check.x, vi_tri_check.z)
		
		# Kho·∫£ng c√°ch < 0.6m t·ª©c l√† ƒëang ƒë·ª©ng tr√πng √¥
		if p1.distance_to(p2) < 0.6:
			return tuong 
	return null

# H√†m t√¨m xem con t∆∞·ªõng ƒëang ƒë·ª©ng tr√™n ƒë·∫ßu Slot n√†o
func tim_slot_duoi_chan(vi_tri_tuong):
	var ds_slot = []
	if has_node("BanCo"): ds_slot.append_array(get_node("BanCo").get_children())
	if has_node("HangCho"): ds_slot.append_array(get_node("HangCho").get_children())
	
	for slot in ds_slot:
		var p1 = Vector2(slot.global_position.x, slot.global_position.z)
		var p2 = Vector2(vi_tri_tuong.x, vi_tri_tuong.z)
		if p1.distance_to(p2) < 0.6:
			return slot
	return null
