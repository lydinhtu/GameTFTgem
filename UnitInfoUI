using TMPro;
using UnityEngine;
using UnityEngine.UI;

public class UnitInfoUI : MonoBehaviour
{
    [Header("Root")]
    public GameObject rootPanel;     // panel chính (UnitInfoPanel)

    [Header("Main")]
    public TMP_Text nameText;
    public Image portraitImage;

    [Header("HP / Mana Bars (Image)")]
    public Image hpBarFill;          // Image thanh máu (màu xanh)
    public Image manaBarFill;        // Image thanh mana

    [Header("6 Stat Texts")]
    // 0: AD, 1: Armor, 2: MR, 3: AS, 4: Range, 5: Move
    public TMP_Text[] statTexts = new TMP_Text[6];

    // unit đang được chọn
    private Unit currentUnit;

    void Awake()
    {
        if (rootPanel == null)
            rootPanel = gameObject;

        Hide();
    }

    void Update()
    {
        if (currentUnit == null) return;

        // === cập nhật thanh máu theo currentHP / maxHP ===
        if (hpBarFill != null && currentUnit.maxHP > 0)
        {
            float ratioHP = (float)currentUnit.currentHP / currentUnit.maxHP;
            hpBarFill.fillAmount = Mathf.Clamp01(ratioHP);
        }

        // === cập nhật thanh mana (nếu sau này bạn dùng) ===
        if (manaBarFill != null && currentUnit.maxMana > 0)
        {
            float ratioMana = (float)currentUnit.currentMana / currentUnit.maxMana;
            manaBarFill.fillAmount = Mathf.Clamp01(ratioMana);
        }
    }

    // Gọi từ UnitSelectionManager khi click vào 1 unit
    public void Show(Unit u)
    {
        if (u == null)
        {
            Hide();
            return;
        }

        currentUnit = u;
        rootPanel.SetActive(true);

        // ====== TÊN & ẢNH ======
        if (nameText != null)
        {
            string displayName = !string.IsNullOrEmpty(u.unitName) ? u.unitName : "Unit";
            if (u.data != null && !string.IsNullOrEmpty(u.data.unitName))
                displayName = u.data.unitName;

            nameText.text = displayName;
        }

        if (portraitImage != null)
        {
            Sprite s = (u.data != null) ? u.data.portrait : null;
            portraitImage.sprite = s;
            portraitImage.enabled = (s != null);
        }

        // ====== CHUẨN HÓA 2 THANH BAR ======
        SetupBarImage(hpBarFill);
        SetupBarImage(manaBarFill);

        // fill lần đầu cho chính xác ngay frame click
        UpdateBarsImmediate();

        // ====== 6 CHỈ SỐ CƠ BẢN ======
        int ad = (u.data != null) ? u.data.attackDamage : u.attackDamage;
        float armor = (u.data != null) ? u.data.armor : u.armor;
        float mr = (u.data != null) ? u.data.magicResist : u.magicResist;
        float aspeed = (u.data != null) ? u.data.attackSpeed : u.attackSpeed;
        int range = (u.data != null) ? u.data.attackRangeTiles : u.attackRangeTiles;
        float move = (u.data != null) ? u.data.moveSpeed : u.moveSpeed;

        if (statTexts != null && statTexts.Length >= 6)
        {
            if (statTexts[0] != null) statTexts[0].text = $"AD: {ad}";
            if (statTexts[1] != null) statTexts[1].text = $"Armor: {armor:0}";
            if (statTexts[2] != null) statTexts[2].text = $"MR: {mr:0}";
            if (statTexts[3] != null) statTexts[3].text = $"AS: {aspeed:0.00}";
            if (statTexts[4] != null) statTexts[4].text = $"Range: {range}";
            if (statTexts[5] != null) statTexts[5].text = $"Move: {move:0.0}";
        }
    }

    private void UpdateBarsImmediate()
    {
        if (currentUnit == null) return;

        if (hpBarFill != null && currentUnit.maxHP > 0)
        {
            float ratioHP = (float)currentUnit.currentHP / currentUnit.maxHP;
            hpBarFill.fillAmount = Mathf.Clamp01(ratioHP);
        }

        if (manaBarFill != null && currentUnit.maxMana > 0)
        {
            float ratioMana = (float)currentUnit.currentMana / currentUnit.maxMana;
            manaBarFill.fillAmount = Mathf.Clamp01(ratioMana);
        }
    }

    private void SetupBarImage(Image img)
    {
        if (img == null) return;

        img.type = Image.Type.Filled;
        img.fillMethod = Image.FillMethod.Horizontal;
        img.fillOrigin = (int)Image.OriginHorizontal.Left;
    }

    public void Hide()
    {
        currentUnit = null;
        if (rootPanel != null)
            rootPanel.SetActive(false);
    }
}
