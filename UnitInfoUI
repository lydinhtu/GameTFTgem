using TMPro;
using UnityEngine;
using UnityEngine.UI;

public class UnitInfoUI : MonoBehaviour
{
    [Header("Root Panel")]
    public GameObject rootPanel;              // chính là UnitInfoPanel

    [Header("Main")]
    public TMP_Text nameText;
    public Image portraitImage;

    [Header("HP / Mana Bars (Image)")]
    public Image hpBarFill;                   // ảnh màu của thanh máu (Fill)
    public Image manaBarFill;                 // ảnh màu của thanh mana (Fill)

    [Header("6 Stat Texts")]
    public TMP_Text[] statTexts = new TMP_Text[6];
    // 0 = AD, 1 = Armor, 2 = MR, 3 = AS, 4 = Range, 5 = Move

    // --- runtime state ---
    private Unit currentUnit;                 // con hiện đang được xem info

    void Awake()
    {
        if (rootPanel == null)
            rootPanel = gameObject;

        Hide();
    }

    void Update()
    {
        // mỗi frame, nếu đang hiển thị 1 con thì cập nhật HP/Mana theo currentHP hiện tại
        if (rootPanel.activeSelf && currentUnit != null)
        {
            RefreshRuntimeBars();
        }
    }

    // Gọi khi click chọn 1 unit
    public void Show(Unit u)
    {
        currentUnit = u;

        if (u == null)
        {
            Hide();
            return;
        }

        rootPanel.SetActive(true);

        // ===== TÊN & ẢNH =====
        if (nameText != null)
        {
            string n = string.IsNullOrEmpty(u.unitName) ? "Unit" : u.unitName;
            nameText.text = n;
        }

        if (portraitImage != null)
        {
            if (u.data != null && u.data.portrait != null)
                portraitImage.sprite = u.data.portrait;
            else
                portraitImage.sprite = null;   // để trống nếu chưa có sprite
        }

        
        // ===== TEXT 6 CHỈ SỐ =====
        if (statTexts != null && statTexts.Length >= 6)
        {
            if (statTexts[0] != null) statTexts[0].text = $"AD: {ad}";
            if (statTexts[1] != null) statTexts[1].text = $"Armor: {armor:0}";
            if (statTexts[2] != null) statTexts[2].text = $"MR: {mr:0}";
            if (statTexts[3] != null) statTexts[3].text = $"AS: {attackSpeed:0.00}";
            if (statTexts[4] != null) statTexts[4].text = $"Range: {range}";
            if (statTexts[5] != null) statTexts[5].text = $"Move: {move:0.0}";
        }

        // set kiểu Fill cho 2 thanh (phòng khi quên chỉnh trong Inspector)
        SetupBarImage(hpBarFill);
        SetupBarImage(manaBarFill);

        // cập nhật lần đầu
        RefreshRuntimeBars();
    }

    // chỉ update fillAmount dựa trên currentHP/currentMana hiện tại
    private void RefreshRuntimeBars()
    {
        if (currentUnit == null) return;

        // HP
        if (hpBarFill != null && currentUnit.maxHP > 0)
        {
            float ratioHP = (float)currentUnit.currentHP / currentUnit.maxHP;
            hpBarFill.fillAmount = Mathf.Clamp01(ratioHP);
        }

        // MANA
        if (manaBarFill != null && currentUnit.maxMana > 0)
        {
            float ratioMana = (float)currentUnit.currentMana / currentUnit.maxMana;
            manaBarFill.fillAmount = Mathf.Clamp01(ratioMana);
        }
    }

    private void SetupBarImage(Image img)
    {
        if (img == null) return;

        img.type = Image.Type.Filled;
        img.fillMethod = Image.FillMethod.Horizontal;
        img.fillOrigin = (int)Image.OriginHorizontal.Left;
    }

    public void Hide()
    {
        currentUnit = null;
        if (rootPanel != null)
            rootPanel.SetActive(false);
    }
}
